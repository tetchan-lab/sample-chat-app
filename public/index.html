<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0 minimum-scale=1.0">
		<title>Sample Socket.io Chat</title>
		<style>
			body {
				margin: 0;
				padding-bottom: 3rem;
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
			}
			#chatForm {
				display: flex;
				border-top: 1px solid #e5e5e5;
				padding-top: 10px;
				padding-bottom: 6px;
				position: fixed;
				bottom: 0px;
				left: 0;
				right: 0;
			}
			#chat-name {
				height: 39px;
				padding-left: 11px;
				box-sizing: border-box;
				border: none;
				/*border-radius: 2rem;*/
				background: #efefef;
				margin: 0px -11px 0px 14px;
				display: none;
			}
			.wrapper {
				position: relative;
				width: 100%;
			}
			#input {
				width: 100%;
				height: 39px; /* é«˜ã•ã‚’èª¿æ•´  å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ */
				font-size: 14px;
				box-sizing: border-box;
				resize: none; /* æ‰‹å‹•ãƒªã‚µã‚¤ã‚ºç¦æ­¢ */
				line-height: 18px; /* æ–‡å­—ã®é«˜ã•å¹…ã‚’èª¿æ•´  ä¸Šä¸‹é–“éš”ã«ãªã‚‹ã®ã«æ³¨æ„ */
				padding-top: 11px;
				padding-left: 18px;
				padding-right: 18px;
				overflow-y: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤º */
				border: none;
				background: #f2f2f2;
				font-family: sans-serif;
				border-radius: 2rem;
				margin-left: 23px;
			}
			#input:focus {
				outline: none;
			}
			.emoji-picker {
				display: none;
				position: absolute;
				background: white;
				border: 1px solid #ddd;
				border-radius: 8px;
				padding: 10px;
				box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
				max-width: 200px;
				flex-wrap: wrap;
				gap: 0px;
				right: -80px;
				bottom: 54px;
			}
			.emoji {
				font-size: 20px;
				cursor: pointer;
				padding: 5px;
				border-radius: 5px;
				transition: background 0.2s;
			}
			.emoji:hover {
				background: #f0f0f0;
			}
			button.emoji-button {
				position: absolute;
				right: -14px;
				top: 9px;
				border: none;
				background: none;
				/*display: none;*/
			}
			/* start ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆtooltipï¼‰ */
			button.emoji-button::after {
				content: attr(data-title);
				position: absolute;
				top: -50px; /* ãƒœã‚¿ãƒ³ã®ä¸Šã«è¡¨ç¤º */
				left: 50%;
				transform: translateX(-50%);
				background: #707070;
				color: #e9e9e9;
				padding: 10px 10px;
				border-radius: 5px;
				font-size: 12px;
				white-space: nowrap;
				opacity: 0;
				visibility: hidden;
				transition: opacity 0.2s ease-in-out;
				pointer-events: none;
			}
			/* å¹ãå‡ºã—ã®ä¸‹ã‚„ã˜ã‚‹ã—ä¸‰è§’å½¢ã‚’ä½œã‚‹ */
			button.emoji-button::before {
				content: "";
				position: absolute;
				top: -12px; /* å¹ãå‡ºã—ã®ä¸‰è§’å½¢ã®ä½ç½® */
				left: 50%;
				transform: translateX(-50%);
				border-width: 5px;
				border-style: solid;
				border-color: #707070 transparent transparent transparent;
				opacity: 0;
				visibility: hidden;
				transition: opacity 0.2s ease-in-out;
			}
			.emoji-button:hover::after,
			.emoji-button:hover::before {
				opacity: 1;
				visibility: visible;
			}
			/* end ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆtooltipï¼‰ */
			button.emoji-button > img {
				width: auto;
				height: 20px;
				filter: invert(51%) sepia(3%) saturate(10%) hue-rotate(15deg) brightness(101%) contrast(92%);
			}
            button.send {
				border: none;
				background: #ffffff;
				margin: 0px 18px 0px 30px;
            }
			button.send > img {
				/*transform: rotateZ(28deg);*/
				width: auto;
				height: 22px;
				filter: invert(1%) sepia(5%) saturate(145%) hue-rotate(314deg) brightness(93%) contrast(91%);
				filter: invert(13%) sepia(9%) saturate(19%) hue-rotate(337deg) brightness(93%) contrast(80%);
				filter: invert(22%) sepia(16%) saturate(4%) hue-rotate(315deg) brightness(102%) contrast(81%);
			}
			#messages {
				list-style-type: none;
				margin: 0 0 23px 0;
				padding: 0; 
				position: fixed;
				width: 100%;
				top: 0px;
				bottom: 46px;
				overflow: auto;
			}
			#messages > li:nth-child(odd) {
				background: #f8f8f8;
			}
			#messages > li {
				display: flex;
				position: relative;
				padding: 0.5rem 1rem;
				animation: fadeIn 0.3s ease 0s 1 normal;
			}
			/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
			@keyframes fadeIn {
				0% {
					opacity: 0;
					transform: translateY(10px);
				}
				100% {
					opacity: 1;
				}
			}
			li > span > img {
				width: auto;
				height: 26px;
				border-radius: 100%;
				/*margin: -20px 7px -8px 7px;*/
			}
			#messages > li time {
				/*position: absolute;
				right: 12px;
				bottom: 12px;*/
				font-size: 0.7rem;
				color: #a8a8a8;
				padding-right: 6px;
				/* display: none; */
			}
			.msg-icon {
				height: 21px;
				padding: 0 12px 0px 6px;
				/* display: none; */
			}
			.msg-name {
				font-size: 12px;
				/*font-weight: bold;*/
				color: #797979;
				color: #146512;
				color: #027523;
				padding-right: 2px;
			}
			.msg-text {
				font-size: 13px;
			}
			@media screen and (max-width: 430px) {
				#input {
					font-size: 16px;
				}
				/*button.emoji-button {
					display: none;
				}*/
				/*#messages {
					width: 100%;
					position: fixed;
					bottom: 44px;
				}*/
				li > span > img {
					height: 26px;
				}
				#messages > li time {
                    padding-right: 3px;
					/*display: none;*/
				}
				.msg-icon {
					height: 21px;
					padding: 0px 10px 0px 0px;
					margin-top: -2px;
				}
				.msg-name {
					font-size: 12px;
					padding-right: 2px;
				}
				.msg-text {
					font-size: 13px;
				}
			}
		</style>
		<style id="emoji-tooltip">
			.emoji-button:hover::after,
			.emoji-button:hover::before {
				opacity: 1;
				visibility: visible;
			}
		</style>
	</head>
	<body>
		<ul id="messages"></ul>
		<form id="chatForm" action="/submit" method="POST">
			<input id="chat-name" value="sampleã‚µãƒ³ãƒ—ãƒ«:">
			<div id="wrapper" class="wrapper">
				<textarea id="input" name="_message" placeholder="ãƒãƒ£ãƒƒãƒˆ..." autocomplete="off"></textarea>
                <input type="hidden" name="_csrf" id="csrf-token">
				<button type="button" id="emoji-button" class="emoji-button" data-title="ã‚¨ãƒ¢ãƒ¼ãƒˆã‚’è¿½åŠ "><img src="icon/face-smile-regular.svg" alt="ğŸ˜€"></button>
				<div id="emoji-picker" class="emoji-picker"></div>
			</div>
			<button type="submit" class="send">
				<img src="icon/paper-plane-regular.svg" class="send-img" alt="Send">
			</button>
		</form>
		<script src="/socket.io/socket.io.js"></script>
		<script>
			window.onload = async function () {
				try {
					await updateCsrfToken(); // HTMLã®èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
				} catch (error) {
					console.error("Failed to retrieve CSRF Token:", error);
				}
			};

			// CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
			async function updateCsrfToken() {
				const res = await fetch('/csrf-token');
				const data = await res.json();
				document.getElementById('csrf-token').value = data.csrfToken;
				console.log("âœ… New CSRF Token retrieved:", data.csrfToken); // (ãƒ‡ãƒãƒƒã‚°ç”¨)
			}
			
			let socket = io();
			const messages = document.getElementById('messages');
			const chatName = document.getElementById('chat-name');
			const input = document.getElementById("input");
			const form = document.getElementById("chatForm");
			const emojiButton = document.getElementById("emoji-button");
			const emojiPicker = document.getElementById("emoji-picker");
			const tooltipStyle = document.getElementById("emoji-tooltip");
			const sendImg = document.querySelector(".send-img");
			let isComposing = false; // IMEå¤‰æ›ä¸­ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹ãƒ•ãƒ©ã‚°
			
			// IMEå¤‰æ›é–‹å§‹æ™‚ã«ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
			input.addEventListener("compositionstart", () => {
				isComposing = true;
			});
			
			// IMEå¤‰æ›ç¢ºå®šæ™‚ã«ãƒ•ãƒ©ã‚°ã‚’è§£é™¤
			input.addEventListener("compositionend", () => {
				isComposing = false;
			});
			
			// è¡¨ç¤ºã™ã‚‹çµµæ–‡å­—ä¸€è¦§
			const emojis = ["ğŸ˜Œ", "ğŸ˜­", "ğŸ˜€", "ğŸ˜", "ğŸ˜‚", "ğŸ¤£", "ğŸ˜ƒ", "ğŸ˜„", "ğŸ˜…", "ğŸ˜†", "â˜ºï¸", "ğŸ˜‡",
							"ğŸ˜", "ğŸ˜¡", "ğŸ˜“", "ğŸ˜´", "ğŸ˜¨", "ğŸ¤”", "ğŸ¥¹", "ğŸ˜”", "ğŸ˜‰", "ğŸ˜Š", "ğŸ˜‹", "ğŸ˜"];
			
			// çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ã‚’ç”Ÿæˆ
			function createEmojiPicker() {
				emojiPicker.innerHTML = ""; // emojiPicker ã®ä¸­èº«ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ï¼ˆæ–°ã—ãä½œã‚Šç›´ã™ãŸã‚ï¼‰
				emojis.forEach(emoji => {
					const span = document.createElement("span"); // <span> è¦ç´ ã‚’ä½œã‚‹
					span.textContent = emoji; // çµµæ–‡å­—ã‚’ <span> ã®ä¸­ã«å…¥ã‚Œã‚‹
					span.classList.add("emoji"); // CSS ã§ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨ã™ã‚‹ãŸã‚ã« emoji ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
					span.addEventListener("click", () => insertEmoji(emoji)); // ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ insertEmoji() ã‚’å®Ÿè¡Œ
					emojiPicker.appendChild(span); // emojiPickerï¼ˆçµµæ–‡å­—ä¸€è¦§ã® divï¼‰ã®ä¸­ã« span ã‚’è¿½åŠ ã™ã‚‹
				});
			}
			
			// çµµæ–‡å­—ã‚’ textarea ã«æŒ¿å…¥
			function insertEmoji(emoji) {
				const cursorPos = input.selectionStart;  // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’å–å¾—
				const textBefore = input.value.substring(0, cursorPos); // ã‚«ãƒ¼ã‚½ãƒ«å‰ã®æ–‡å­—ã‚’å–å¾—
				const textAfter = input.value.substring(cursorPos); //ã‚«ãƒ¼ã‚½ãƒ«å¾Œã®æ–‡å­—ã‚’å–å¾—
				input.value = textBefore + emoji + textAfter; // æ–°ã—ã„æ–‡å­—åˆ—ã‚’ä½œæˆï¼ˆã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«çµµæ–‡å­—ã‚’æŒ¿å…¥ï¼‰
				input.focus(); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã—ã¦å¼•ãç¶šãå…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
			}
			
			// ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚‰çµµæ–‡å­—ä¸€è¦§ã‚’è¡¨ç¤ºãƒ»éè¡¨ç¤º
			emojiButton.addEventListener("click", (event) => {
				createEmojiPicker(); // é–¢æ•°ã‚’å®Ÿè¡Œ çµµæ–‡å­—ãƒªã‚¹ãƒˆã‚’ä½œæˆ
				// if æ–‡ã‚’çŸ­ãã‹ã„ãŸ ä¸‰é …æ¼”ç®—å­ï¼ˆ?:ï¼‰ã‚’ä½¿ã£ãŸæ¡ä»¶åˆ†å²
				emojiPicker.style.display = emojiPicker.style.display === "flex" ? "none" : "flex";
				// ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’éè¡¨ç¤ºã«ã™ã‚‹
				tooltipStyle.textContent = `
					.emoji-button:hover::after,
					.emoji-button:hover::before {
						opacity: 0;
						visibility: hidden;
					}
				`;
			});
			
			// ã‚¯ãƒªãƒƒã‚¯ã§çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‰ã˜ã‚‹ï¼ˆãƒœã‚¿ãƒ³ã¨ãƒ”ãƒƒã‚«ãƒ¼ä»¥å¤–ï¼‰ï¼† tooltip ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æˆ»ã™
			document.addEventListener("click", (event) => {
				if (!emojiButton.contains(event.target) && !emojiPicker.contains(event.target)) {
					emojiPicker.style.display = "none";
					tooltipStyle.textContent = `
						.emoji-button:hover::after,
						.emoji-button:hover::before {
							opacity: 1;
							visibility: visible;
						}
					`;
				}
			});
			
			// ãƒ†ã‚­ã‚¹ãƒˆã®å¹…ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
			function getTextWidth(text, font) {
				const canvas = document.createElement("canvas"); // canvas è¦ç´ ã‚’ä½œæˆ
				const context = canvas.getContext("2d"); // 2Dã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆgetContext("2d")ã‚’å–å¾—
				context.font = font; // textarea ã®ãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨
				return context.measureText(text).width; // ãƒªã‚¿ãƒ¼ãƒ³ã§ã€Œç¾åœ¨ã®ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šã§ text ã‚’æã„ãŸæ™‚ã®æ¨ªå¹…ã€ã‚’è¿”ã™
			}
			
			// ã‚¹ãƒãƒ›åˆ¤å®šé–¢æ•°
			function isMobile() {
				return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
			}
			
			/*if (isMobile()) {
				emojiButton.style.display = "none"; // ã‚¹ãƒãƒ›ãªã‚‰ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
			}*/
			
			// è‡ªå‹•ãƒªã‚µã‚¤ã‚ºé–¢æ•°
			function adjustTextareaHeight() {
				input.style.height = "39px"; // ä¸€åº¦ãƒªã‚»ãƒƒãƒˆã™ã‚‹
				
				const newLine = input.value.includes("\n"); // æ”¹è¡Œã®ç¢ºèªã€‚
				const twoHeight = 49; // 2è¡Œåˆ†ã®é«˜ã•
				let newHeight = input.scrollHeight; // ç¾åœ¨ã®é«˜ã•
				
				//console.log("ç¾åœ¨ã®é«˜ã•:", newHeight); // ç¾åœ¨ã®é«˜ã•ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
				//console.log("ï¼’è¡Œåˆ†ã®é«˜ã•:", twoHeight); // ï¼’è¡Œåˆ†ã®é«˜ã•ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
				
				// textarea ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å–å¾—ã—ã¦ãƒ•ã‚©ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—
				const textareaStyle = window.getComputedStyle(input);
				const font = `${textareaStyle.fontSize} ${textareaStyle.fontFamily}`;
				
				// ç¾åœ¨ã®å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã®å¹…ã‚’è¨ˆç®—
				const TextWidth = getTextWidth(input.value, font); // ç¾åœ¨ã®å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚’getTextWidth() ã«æ¸¡ã™
				//console.log("Text Width:", TextWidth); // ãƒ‡ãƒãƒƒã‚°ç”¨
				
				// textarea ã® padding ã‚’å–å¾—
				const paddingLeft = parseFloat(textareaStyle.paddingLeft);
				const paddingRight = parseFloat(textareaStyle.paddingRight);
				const textPadding = paddingLeft + paddingRight; // åˆè¨ˆã®padding
				const margin = 55;  // ä½™åŠ›ã®å€¤ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
				
				// ãƒ†ã‚­ã‚¹ãƒˆå¹…ã«paddingåˆ†ã¨ä½™åŠ›åˆ†ã®æ•°å­—ã‚’åŠ ãˆã‚‹
				const adjustedTextWidth = TextWidth + textPadding + margin;
				//console.log("Adjusted Text Width:", adjustedTextWidth); // ãƒ‡ãƒãƒƒã‚°ç”¨
				
				// emojiãƒœã‚¿ãƒ³ã®å·¦å´ã®ä½ç½®ã‚’å–å¾—
				const emojiButtonLeft = emojiButton.getBoundingClientRect().left;
				//console.log("emojiButton Left: ", emojiButtonLeft); // ãƒ‡ãƒãƒƒã‚°ç”¨
				
				// PCã‹ã‚¹ãƒãƒ›ã‹åˆ¤å®šã—ã¦ã€å€‹åˆ¥ã®æ¡ä»¶ã§å‡¦ç†ã‚’ã•ã›ã‚‹ã€‚ã‚¹ãƒãƒ›ãªã‚‰emojiãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’è€ƒæ…®ã—ãªã„ 
				/*if (isMobile()) {
					// ã‚‚ã—æŠ˜ã‚Šè¿”ã—ãŒç™ºç”Ÿã—2è¡Œåˆ†ã«ãªã£ãŸã‚‰
					if (newHeight >= twoHeight) {
						input.style.height = "89px"; // 4è¡Œåˆ†ã®é«˜ã•ã«å¤‰æ›´
						messages.style.marginBottom = "70px"; // ul ã‚’ï¼”è¡Œåˆ†ã®é«˜ã•ä¸Šã’ã‚‹
						messages.scrollTo(0, messages.scrollHeight); // messageså†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€ç•ªä¸‹ã¸
					} else {
						// å…ƒã®å€¤ã«æˆ»ã™
						messages.style.marginBottom = "23px";
					}
				} else {*/
					 // PCãªã‚‰emojiãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’è€ƒæ…®ã™ã‚‹
					 //ã‚‚ã—æŠ˜ã‚Šè¿”ã—ãŒç™ºç”Ÿã—2è¡Œåˆ†ã«ãªã‚‹ã€ã‚ã‚‹ã„ã¯æ–‡å­—ãŒãƒœã‚¿ãƒ³å·¦ç«¯ã®è·é›¢ã¾ã§ããŸã‚‰4è¡Œåˆ†ã®é«˜ã•ã‚’ç¢ºä¿
					if (newHeight >= twoHeight || adjustedTextWidth >= emojiButtonLeft) {
						input.style.height = "89px"; // 4è¡Œåˆ†ã®é«˜ã•ã«å¤‰æ›´
						messages.style.marginBottom = "70px"; // ul ã‚’ï¼”è¡Œåˆ†ã®é«˜ã•ä¸Šã’ã‚‹
						messages.scrollTo(0, messages.scrollHeight); // messagesã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€ç•ªä¸‹ã¸
						// çµµæ–‡å­—ãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’å³ä¸‹ã«èª¿æ•´ã™ã‚‹
						emojiButton.style.top = "88%";
						emojiButton.style.transform = "translateY(-88%)";
					} else {
						// å…ƒã®å€¤ã«æˆ»ã™
						messages.style.marginBottom = "23px";
						emojiButton.style.top = "9px";
						emojiButton.style.transform = "none";
					}
				//}
			
				input.style.height = Math.min(input.scrollHeight, 205) + "px"; // æœ€å¤§205pxã¾ã§æ‹¡å¤§
				
				// PCã‹ã‚¹ãƒãƒ›ã‹åˆ¤å®šã—ã¦ã€å€‹åˆ¥ã®æ¡ä»¶ã§border-radiusã®å€¤ã‚’å¤‰æ›´ã™ã‚‹ã€‚ã‚¹ãƒãƒ›ãªã‚‰emojiãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’è€ƒæ…®ã—ãªã„ 
				/*if (isMobile()) {
					// ã‚‚ã—æ”¹è¡ŒãŒã‚ã‚‹ or ç¾åœ¨ã®é«˜ã•ãŒï¼’è¡Œåˆ†(49px)ã‚’ã“ãˆãŸã‚‰ã€è‡ªå‹•ã§border-radiusã®å€¤ã‚’å¤‰æ›´ã™ã‚‹ã€‚
					if (newLine || newHeight >= twoHeight) {
						input.style.borderRadius = "0.8rem"; // æ”¹è¡Œã‚ã‚Š â†’ 0.8rem
					} else {
						input.style.borderRadius = "2rem"; // æ”¹è¡Œãªã— â†’ 2rem
					}
				} else {*/
					// PCãªã‚‰emojiãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’è€ƒæ…®ã™ã‚‹
					// æ”¹è¡ŒãŒã‚ã‚‹ or ç¾åœ¨ã®é«˜ã•ãŒï¼’è¡Œåˆ†(49px)ã«ãªã‚‹ or æ–‡å­—ãŒãƒœã‚¿ãƒ³å·¦ç«¯ã®è·é›¢ã¾ã§ãã¦ã„ãŸã‚‰å€¤ã‚’å¤‰æ›´ã™ã‚‹ã€‚
					if (newLine || newHeight >= twoHeight || adjustedTextWidth >= emojiButtonLeft) {
						input.style.borderRadius = "0.8rem"; // æ”¹è¡Œã‚ã‚Š â†’ 0.8rem
					} else {
						input.style.borderRadius = "2rem"; // æ”¹è¡Œãªã— â†’ 2rem
					}
				}
			//}
			
			// å…¥åŠ›æ™‚ã«é«˜ã•ã‚’èª¿æ•´
			input.addEventListener("input", adjustTextareaHeight);
			
			// ã‚·ãƒ•ãƒˆ+ã‚¨ãƒ³ã‚¿ãƒ¼ã§æ”¹è¡Œã€é€šå¸¸ã®ã‚¨ãƒ³ã‚¿ãƒ¼ã§é€ä¿¡
			input.addEventListener("keydown", (event) => {
				if (event.key === "Enter") {
					if (isComposing) {
						return; // IMEå¤‰æ›ä¸­ãªã‚‰é€ä¿¡ã—ãªã„
					}
					
					if (event.shiftKey) {
					// ã‚·ãƒ•ãƒˆ+ã‚¨ãƒ³ã‚¿ãƒ¼ãªã‚‰æ”¹è¡Œ
						event.preventDefault();
						const cursorPos = input.selectionStart; // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’å–å¾—
						const textBefore = input.value.substring(0, cursorPos); // ã‚«ãƒ¼ã‚½ãƒ«å‰ã®æ–‡å­—ã‚’å–å¾—
						const textAfter = input.value.substring(cursorPos); //ã‚«ãƒ¼ã‚½ãƒ«å¾Œã®æ–‡å­—ã‚’å–å¾—
						input.value = textBefore + "\n" + textAfter; // æ–°ã—ã„æ–‡å­—åˆ—ã‚’ä½œæˆ
						input.selectionStart = input.selectionEnd = cursorPos + 1; // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’èª¿æ•´
						adjustTextareaHeight();
					} else {
						// ã‚¨ãƒ³ã‚¿ãƒ¼ã®ã¿ãªã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
						event.preventDefault();
						form.requestSubmit(); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
					}
				}
			});
			
			// å…¥åŠ›æ™‚ã«é€ä¿¡ãƒœã‚¿ãƒ³ç”»åƒã®è‰²ã‚’å¤‰ãˆã‚‹
			input.addEventListener("input", (event) => {
				// ç©ºã‹ã¤æ”¹è¡Œã®å ´åˆã¯é™¤å¤–
				if (input.value.trim() && !(input.value.trim() === "" && input.value.includes("\n"))) {
					sendImg.style.filter = 
					"invert(23%) sepia(67%) saturate(3090%) hue-rotate(201deg) brightness(93%) contrast(101%)";
				} else {
					sendImg.style.filter = 
					"invert(22%) sepia(16%) saturate(4%) hue-rotate(315deg) brightness(102%) contrast(81%)";
				}
			});
			
			// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
			form.addEventListener("submit", async (event) => {
				event.preventDefault(); // ãƒšãƒ¼ã‚¸é·ç§»ã‚’é˜²ã
				const trimmedValue = input.value.trim(); // å‰å¾Œã®ç©ºç™½ã¨æ”¹è¡Œã‚’é™¤å»
				
				if (trimmedValue && !(trimmedValue === "" && input.value.includes("\n"))) {

					try {
						const formData = new FormData(form);
						const message = formData.get("_message");
						const csrfToken = formData.get("_csrf");

						// ã‚µãƒ¼ãƒãƒ¼ã¸POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ï¼ˆCSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«å«ã‚ã‚‹ï¼‰
						const response = await fetch('/submit', {
							method: "POST",
							headers: {
								"Content-Type": "application/json",
								"CSRF-Token": csrfToken  // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š
							},
							body: JSON.stringify({ message })
						});

						const result = await response.json();
						console.log("Server response:", result);

						// é€ä¿¡å¾Œã«æ–°ã—ã„ CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
						await updateCsrfToken();

					} catch (error) {
						console.error("Error during form submission:", error);
					}

					console.log("é€ä¿¡ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:", trimmedValue); // é€ä¿¡å†…å®¹ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰

					socket.emit('chat message', {
						text: input.value,
						name: chatName.value
					});
					
					input.value = ""; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
					input.style.height = "39px"; // åˆæœŸã®é«˜ã•ã«æˆ»ã™
					input.style.borderRadius = "2rem"; // åˆæœŸå€¤ã«æˆ»ã™
					input.blur(); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã™ï¼ˆã‚¹ãƒãƒ›ãªã‚‰ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹ï¼‰
					emojiButton.style.top = "9px"; // åˆæœŸã®é«˜ã•ã«æˆ»ã™
					emojiButton.style.transform = "none"; // åˆæœŸå€¤ã«æˆ»ã™
					messages.style.marginBottom = "23px"; // åˆæœŸã«æˆ»ã™
					
					// é€ä¿¡ãƒœã‚¿ãƒ³ã®è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
					sendImg.style.filter = 
					"invert(22%) sepia(16%) saturate(4%) hue-rotate(315deg) brightness(102%) contrast(81%)";
					
					// PCãªã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™ï¼ˆã‚¹ãƒãƒ›ã§ã¯æˆ»ã•ãªã„ï¼‰
					if (!isMobile()) {
						setTimeout(() => input.focus(), 100);
					}
				}
				//  ä¸‹è¨˜ã¯åŒã˜æ¡ä»¶å¼ã®ã‚‚ã†ä¸€ã¤ã®æ–¹æ³•ã€‚ã©ã£ã¡ãŒåˆ†ã‹ã‚Šã™ã„ã‹æ‚©ã¾ã—ã„ã€‚
				// if (trimmedValue && input.value.replace(/\n/g, "").trim() !== "")
			});
			
			// æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒããŸæ™‚ã®å‡¦ç†
			socket.on('chat message', function(msg) {
				// æŠ•ç¨¿æ™‚é–“ã‚’å–å¾—ã™ã‚‹
				let postTime = new Date().toLocaleString("en-US",{
					timeZone: "Asia/Tokyo",
					hour: "numeric",
					minute: "numeric",
					hour12: true
				}); // è‹±èªåœã®ãƒ­ã‚±ãƒ¼ãƒ«ï¼ˆä¾‹: en-USï¼‰ã‚’ä½¿ã„ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã§æ—¥æœ¬ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
				let item = document.createElement('li');
				item.innerHTML = `
					<span class="msg-icon"><img src="/icon/profile_sample_image-300x300.jpg"></span>
					<div class="msg-contents">
						<time>${postTime}</time>
						<span class="msg-name">${msg.name}</span>
						<span class="msg-text">${msg.text}</span>
					</div>
				`;
				messages.appendChild(item);
				messages.scrollTo(0, messages.scrollHeight); // messageså†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€ç•ªä¸‹ã¸
				//window.scrollTo(0, document.body.scrollHeight);
			});
		</script>
	</body>
</html>